<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>¿Cómo evitar el muñequito de la Rosca de Reyes?</title>
	
	<script src="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.blue_grey-cyan.min.css" />
	<!--link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.grey-blue.min.css" /-->
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="http://underscorejs.org/underscore-min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	
	<style>
		@import url(http://fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic);
		@import url(http://fonts.googleapis.com/css?family=Merriweather);
		@import url(https://fonts.googleapis.com/css?family=Lato);
		@import url(https://fonts.googleapis.com/css?family=Roboto:400,900italic);

		
		h1{
			width:490px;
			padding-left:5px;
			font-size:24px;
			fill: #333333;
			font-family: 'Merriweather', serif;
			text-align: left;
		}
		
		h2{
			width:490px;
			margin: 5px 0 0 0;
			padding-left:5px;
			padding-top:5px;
			color: #555655;
			font-family: 'Merriweather', sans-serif;
			font-size:12px;
			font-weight: normal;
		}
		
		.header{
			text-align:center;
			padding-top:8px;
			padding-bottom: 8px;
			color: #555655;
			font-family: 'Merriweather', sans-serif;
			font-size:12px;
			font-weight: normal;
			background: #FAF6ED;
		}
		#fuente{
			font-size:12px;
			color: #555655;
			font-family: 'Merriweather', serif; 
		}
		
		#twInfo{
			font-size:14px;
			color: #555655;
			font-family: 'Roboto', sans-serif;
			font-weight:900;
			font-style:italic;
		}
		
		.mdl-button__label, .mdl-textfield__input, .mdl-textfield__label{
			font-size:14px;
			color:#555655;
			opacity:0.87;
			text-align:center;
		}
		
		.mdl-layout__content{
			max-width:490px;
			background: #FAF6ED;
		}
		
		.bar {
			box-sizing: border-box;
			background: #FAF6ED;
			width: 100%;
			padding:8px 4px 4px 4px;
		}
				
		.mdl-grid{
			padding:0;
		}
		
		.axis text, .axisTick {
			font-family: 'Lato', sans-serif;
			font-weight:normal;
			font-size: 12px;
			fill:#808080;
		}

		.axis path,
		.axis line {
			fill: none;
			stroke: #808080;
			shape-rendering: crispEdges;
		}
		
		.x.axis path{
			display:none;
		}

		.label, .circleLabel{
			font-family:'Lato',sans-serif;
			font-size:12px;
			fill:#808080;
		}
		
		.dashLine{
			stroke-dasharray: 3,3;
			stroke: #404040;
			stroke-width: 1px;
		}
		
		.btn-group{
			font-size:12px;
			font-family: 'Roboto', sans-serif;
			font-weight:400;
			color:#565656;
		
		}
		
		.btn-default {
			color: #565656;
			background-color: #FAF6ED;
			border-color: #ccc;
			font-size:14px;
			font-family: 'Roboto', sans-serif;
			font-weight:400;
			color:#565656;
		}
		
		.dropdown-menu{
			max-height: 130px;
			overflow-y: auto;
			overflow-x: hidden;
		}
	</style>
</head>
<body>

<div style="max-width:490px;"> <!--class="mdl-layout--fixed-header mdl-js-layout" style="max-width:490px;"-->
	<!--header class="mdl-layout__header"-->
	
	<div class="header"><b>¿Cómo evitar el muñequito de la Rosca de Reyes?</b><span id="title"></span></div>
		
	
	<!--------------------------- Button Bar ------------------------------------->
	<div class="btn-group btn-group-justified" role="group" aria-label="...">
		<div class="btn-group" role="group">
			<button id="menu-Jesus" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Muñecos:  3</button>
			<ul class="dropdown-menu">
				<li><a class="menu__item" href="#">1</a></li>
				<li><a class="menu__item" href="#">2</a></li>
				<li><a class="menu__item" href="#">3</a></li>
				<li><a class="menu__item" href="#">4</a></li>
				<li><a class="menu__item" href="#">5</a></li>
				<li><a class="menu__item" href="#">6</a></li>
				<li><a class="menu__item" href="#">7</a></li>
				<li><a class="menu__item" href="#">8</a></li>
				<li><a class="menu__item" href="#">9</a></li>
				<li><a class="menu__item" href="#">10</a></li>
			</ul>
		</div>
		<div class="btn-group" role="group">
			<button id="menu-Slices" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Rebanadas:  9</button>
			<ul class="dropdown-menu" style="max-height: 130px; overflow-y: auto; overflow-x: hidden;">
				<li><a class="menu__item" href="#">1</a></li>
				<li><a class="menu__item" href="#">2</a></li>
				<li><a class="menu__item" href="#">3</a></li>
				<li><a class="menu__item" href="#">4</a></li>
				<li><a class="menu__item" href="#">5</a></li>
				<li><a class="menu__item" href="#">6</a></li>
				<li><a class="menu__item" href="#">7</a></li>
				<li><a class="menu__item" href="#">8</a></li>
				<li><a class="menu__item" href="#">9</a></li>
				<li><a class="menu__item" href="#">10</a></li>
				<li><a class="menu__item" href="#">11</a></li>
				<li><a class="menu__item" href="#">12</a></li>
				<li><a class="menu__item" href="#">13</a></li>
				<li><a class="menu__item" href="#">14</a></li>
				<li><a class="menu__item" href="#">15</a></li>
				<li><a class="menu__item" href="#">16</a></li>
				<li><a class="menu__item" href="#">17</a></li>
				<li><a class="menu__item" href="#">18</a></li>
				<li><a class="menu__item" href="#">19</a></li>
				<li><a class="menu__item" href="#">20</a></li>
			</ul>
		</div>
		<div class="btn-group" role="group">
			<button type="button" class="btn btn-default" id="submit" disabled onclick="draw();">Calcular</button>
		</div>
	</div>
	
	<!--/header-->
	<main class="mdl-layout__content">
		<h2>Tu probabilidad depende del número de rebanadas repartidas.</h2>
		<div id="vis">
		</div>
		<div class="mdl-grid" style="max-width:490px; margin-left:0;">
			<div class="mdl-cell mdl-cell--9-col-desktop mdl-cell--3-col-phone  mdl-cell--middle" id="fuente">Fuente: Numérico.</div>
			<div class="mdl-cell mdl-cell--3-col-desktop mdl-cell--1-col-phone  mdl-cell--middle" id="twInfo" style="text-align:right;">@numericomx</div>
		</div>
  </main>
</div>

<script>

var slices=9;
var babies=3;

//Dimensions for the graph canvas
var margin = {top: 30, right: 150, bottom: 40, left: 10, leftAxis: 20, rightAxis: 10, topAxis: 10, bottomAxis: 10},
    width = 490 - margin.left - margin.right;
    height = 500 - margin.top - margin.bottom;

//Adds the svg to the canvas
var svg = d3.select("#vis")
			.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform", "translate(" + margin.left+ "," + margin.top + ")");

//Set the ranges for x and y
var x = d3.scale.linear()
	.domain([0, width])
	.range([0, width]);
	
var y = d3.scale.linear()
	.domain([margin.top, height])
	.range([height, 0]);

//Dibuja gráfica por defecto
draw();
document.getElementById("submit").disabled = false;

function draw(){
	var probMuñeco = [];
	var probNoMuñeco = [];
	var numRebanada = [];
	
	for(var i=0;i<slices;i++){
		numRebanada[i] = i;
		if(babies == slices){
			probNoMuñeco[i] = 1;
		}else{
			probNoMuñeco[i] = 1- hyp(0,i+1,babies,slices);
		}
		probMuñeco[i] = hyp(1,i+1,babies,slices);
	}
	
	var data = probNoMuñeco;
	console.log(probNoMuñeco);
	
	//Clean all the vis
	svg.selectAll("circle").remove();
	svg.selectAll("rect").remove();
	svg.selectAll("g").remove();
	svg.selectAll("g").remove();
	svg.selectAll(".circleLabel").remove();
	svg.selectAll(".dashLine").remove();
	svg.selectAll(".axisTick").remove();

	//Set the ranges for x and y
	x.domain([1, data.length]);
		
	y.domain([0, d3.max(data)]);
	
	//Setting the axes
	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom");

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("right")
		.ticks(0);
	
	//Drawing percentage lines
	svg.append("line")
		.attr("class","dashLine")
		.attr("x1", 0)
		.attr("y1", y(.25))
		.attr("x2", width+70)
		.attr("y2", y(.25));
	svg.append("text")
		.attr("class","axisTick")
		.attr("transform","translate("+(width+75) +","+(y(.24))+")")
		.text("25%");
	
	svg.append("line")
		.attr("class","dashLine")
		 .attr("x1", 0)
		 .attr("y1", y(.50))
		 .attr("x2", width+70)
		 .attr("y2", y(.50));
	svg.append("text")
		.attr("class","axisTick")
		.attr("transform","translate("+(width+75) +","+(y(.49))+")")
		.text("50%");
	
	svg.append("line")
		.attr("class","dashLine")
		 .attr("x1", 0)
		 .attr("y1", y(.75))
		 .attr("x2", width+70)
		 .attr("y2", y(.75));
	svg.append("text")
		.attr("class","axisTick")
		.attr("transform","translate("+(width+75) +","+(y(.74))+")")
		.text("75%");
	
	svg.append("line")
		.attr("class","dashLine")
		 .attr("x1", 0)
		 .attr("y1", y(1))
		 .attr("x2", width+70)
		 .attr("y2", y(1));
	svg.append("text")
		.attr("class","axisTick")
		.attr("transform","translate("+(width+75) +","+(y(.99))+")")
		.text("100%")
	
	//Draw lollipop chart (bars and circles)
	svg.selectAll("circle")
		.data(data)
		.enter().append("circle")
			//.transition().delay(10).duration(1000)
			.attr("r",5)
			.attr("cy", function(d){return y(d);})
			.attr("cx", function(d,i){return x(i+1)+margin.leftAxis;})
			.attr("id", function(d,i){return "circle"+i;})
			.attr("class", "circle")
			.style("fill",function(d){return "#"+color(d*100);});
	
	svg.selectAll("text")
		.data(data)
		.enter().append("text")
			//.transition().delay(10).duration(1000)
			.attr("class","circleLabel")
			.attr("id", function(d,i){return "value"+i;})
			.attr("y",function(d){return y(d)-25;})
			.attr("x",function(d,i){return x(i+1)+margin.leftAxis;})
			.attr("dy","1em")
			.style("text-anchor","middle")
			.style("opacity",0)
			.text(function(d){return d3.format("%")(d);});
	
	svg.selectAll("rect")
		.data(data)
		.enter().append("rect")
			//.transition().delay(10).duration(1000)
			.attr("x", function(d,i){return x(i+1)-1+margin.leftAxis;})
			.attr("y", function(d){return y(d);})
			.attr("height", function(d){return height-y(d);})
			.attr("width", 1.5)
			.style("fill",function(d){return "#"+color(d*100);})
			.style("opacity",0.8);
		 
	//Drawing axes on the chart
	svg.append("g")
		.transition().delay(10).duration(1000)
		.attr("class", "x axis")
		.attr("transform", "translate("+margin.leftAxis+","+(height)+")")
		.call(xAxis);
	
	svg.append("g")
		.transition().delay(10).duration(1000)
		.attr("class", "y axis")
		.call(yAxis);
	
	//Writing axes labels if there isn't
	if(document.getElementById("axisLabel") == null ){
		svg.append("text")
		.transition().delay(10).duration(1000)
		.attr("class","label")
		.attr("id","axisLabel")
		.attr("transform","translate("+ (width-margin.right) +","+(height+35)+")")
		.style("text-anchor","middle")
		.text("Rebanadas repartidas");
		
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.91))+")")
			.style("text-anchor","middle")
			.text("Tu Guadalupe-Reyes");	
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.86))+")")
			.style("text-anchor","middle")
			.text("acaba en febrero.");
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.81))+")")
			.style("text-anchor","middle")
			.text("Ahorra.");
			
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.66))+")")
			.style("text-anchor","middle")
			.text("Quizás puedas");	
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.61))+")")
			.style("text-anchor","middle")
			.text("compartir gastos con");
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.56))+")")
			.style("text-anchor","middle")
			.text("alguien más.");
			
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.385))+")")
			.style("text-anchor","middle")
			.text("Échate");
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.335))+")")
			.style("text-anchor","middle")
			.text("un volado.");
		
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.15))+")")
			.style("text-anchor","middle")
			.text("Sólo con muy mala");
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.10))+")")
			.style("text-anchor","middle")
			.text("suerte tú pagas");
		svg.append("text")
			.transition().delay(10).duration(1000)
			.attr("class","label")
			.attr("id","axisLabel")
			.attr("transform","translate("+(width+85) +","+(y(.05))+")")
			.style("text-anchor","middle")
			.text("los tamales.");
	}
	
	d3.selectAll(".circle").on("mouseover",mouseOver).on("mouseout",mouseOut);
	
	function mouseOver(d,i){
		var circleID = d3.select(this).attr("id");
		d3.select("#"+circleID.replace("circle","value"))
			.transition().delay(10).duration(200)
			.style("opacity",1);
	}

	function mouseOut(d,i){
		var circleID = d3.select(this).attr("id");
		d3.select("#"+circleID.replace("circle","value"))
			.transition().delay(10).duration(200)
			.style("opacity",0);
	}
}

function color(d){
	if(d>=0 && d<25){
		return "96CD39";
	}else if(d>=25 && d<50){
		return "FCE850";
	}else if(d>=50 && d<75){
		return "FFBA47";
	}else{
		return "FF5B44";
	}
}

$(".menu__item").click(function(){
	var option = Number($(this).text());
	var menu = $(this).parent().parent().parent().find("button").attr("id");
	if(menu == "menu-Jesus"){
		$("#menu-Jesus").text($("#menu-Jesus").text().split(":")[0]+": "+option);
		babies = option;
	}else if(menu == "menu-Slices"){
		$("#menu-Slices").text($("#menu-Slices").text().split(":")[0]+": "+option);
		slices = option;
	}
	
	if(babies<=slices && babies>0 && slices>0){
		draw();
		document.getElementById("submit").disabled = false;
	}else if(babies>slices){
		
		document.getElementById("submit").disabled = true;
	}
});

/**
Hypergeometric function
x = 0 or 1 (failure or success)
n = size of the sample
m = size of the subpopulation
nn = size of the population
**/
function hyp(x, n, m, nn) {
  var nz, mz;
  // best to have n<m
  if (m < n) {
    nz = m;
    mz = n
  } else {
    nz = n;
    mz = m
  }
  var h=1;
  var s=1;
  var k=0;
  var i=0;
  while (i < x) {
    while (s > 1 && k < nz) {
      h = h * (1 - mz / (nn - k));
      s = s * (1 -mz / (nn - k));
      k = k + 1;
    }
    h = h * (nz - i) * (mz - i) / (i + 1) / (nn - nz - mz + i + 1);
    s = s + h;
    i = i + 1;
  }
  while (k < nz) {
    s = s * (1 - mz / (nn - k));
    k = k + 1;
  }
  return s;
}

</script>